# hw definition file for processing by chibios_pins.py
# for Nickel H743 hw

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID. See Tools/AP_Bootloader/board_types.txt 
APJ_BOARD_ID 1

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 8000000

MCU_CLOCKRATE_MHZ 480

FLASH_SIZE_KB 2048

# ChibiOS system timer
STM32_ST_USE_TIMER 12
define CH_CFG_ST_RESOLUTION 16

# leave 1 sectors free
FLASH_RESERVE_START_KB 384
env OPTIMIZE -O2

# use last 2 pages for flash storage
# H743 has 16 pages of 128k each
STORAGE_FLASH_PAGE 1
define HAL_STORAGE_SIZE 32768

# PA10 IO-debug-console
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART3 UART4 UART7

# USART3 (GPS)
PD8 USART3_TX USART3
PD9 USART3_RX USART3
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_GPS

# UART4 (WiFi)
PD1 UART4_TX UART4 NODMA
PD0 UART4_RX UART4 NODMA

# UART7 (RX / SBUS)
PE8 UART7_TX UART7
PE7 UART7_RX UART7
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_RCIN
define DEFAULT_SERIAL1_BAUD 115

# UART8
#PE1 UART8_TX UART8 NODMA
#PE0 UART8_RX UART8 NODMA

# SPI1 for ICM-42688
PA4 ICM42688_CS CS
PA5 SPI1_SCK SPI1
PB4 SPI1_MISO SPI1
PD7 SPI1_MOSI SPI1

# SPI2 for ICM-42605
PC0 ICM42605_CS CS
PA9 SPI2_SCK SPI2
PC2 SPI2_MISO SPI2
PC1 SPI2_MOSI SPI2

# SPI3 for magnet
#PA14 FLASH_CS CS
#PC10 SPI3_SCK SPI3
#PC11 SPI3_MISO SPI3
#PB2  SPI3_MOSI SPI3

# SPI SD card setup
#SDCARD_TYPE SPISD
#SDCARD_SPI  SPI3

# SPI4 for BMM150 MAG
PE12 BMM150_CS CS
PE2 SPI4_SCK SPI4
PE13  SPI4_MISO SPI4
PE14 SPI4_MOSI SPI4
PF3 DRDY1_BMM150 INPUT

# SPI devices
SPIDEV icm42688  SPI1 DEVID1 ICM42688_CS MODE3  2*MHZ  8*MHZ
SPIDEV icm42688  SPI2 DEVID2 ICM42605_CS MODE3  2*MHZ  8*MHZ
SPIDEV bmm150    SPI4 DEVID1 BMM150_CS   MODE0  1*MHZ 10*MHZ

# IMU's 
IMU Invensensev3 SPI:icm42688 ROTATION_NONE
IMU Invensensev3 SPI:ICM42605 ROTATION_NONE

define HAL_DEFAULT_INS_FAST_SAMPLE 5

#MAG
MAG BMM150 SPI:bmm150 ROTATION_NONE

# one I2C bus
I2C_ORDER I2C2 I2C4 

# I2C2
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# I2C4
PD12 I2C4_SCL I2C4
PD13 I2C4_SDA I2C4


# ADC inputs, scale 10 is used so voltages
# stay in 3.3v max range with 6S
PA6 CELL1 ADC1 SCALE(10) ANALOG(1)
PA7 CELL2 ADC1 SCALE(10) ANALOG(2)
PC4 CELL3 ADC1 SCALE(10) ANALOG(3)
PC5 CELL4 ADC1 SCALE(10) ANALOG(4)
PB0 CELL5 ADC1 SCALE(10) ANALOG(5)
PB1 CELL6 ADC1 SCALE(10) ANALOG(6)

# define default battery setup
define HAL_BATT_MONITOR_DEFAULT 4

# LED setup is similar to PixRacer
PB8 LED_RED OUTPUT GPIO(95)
PD10 LED_GREEN OUTPUT GPIO(57)
PB13 LED_BLUE OUTPUT GPIO(52)
PB7 LED_YELOW OUTPUT GPIO(93)

define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1
define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 95
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 57
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 52


# Motors
PA0  TIM2_CH1 TIM2 PWM(1) GPIO(22)
PA1  TIM2_CH2 TIM2 PWM(2) GPIO(23)
PA2  TIM2_CH3 TIM2 PWM(3) GPIO(24)
PA3  TIM2_CH4 TIM2 PWM(4) GPIO(25)
PE9  TIM1_CH1 TIM1 PWM(5) GPIO(39)
PE11  TIM1_CH2 TIM1 PWM(6) GPIO(41)
PC6  TIM3_CH1 TIM3 PWM(7) GPIO(63)
PC7  TIM3_CH2 TIM3 PWM(8) GPIO(64)
PC8  TIM3_CH3 TIM3 PWM(9) GPIO(65)
PC9  TIM3_CH4 TIM3 PWM(10) GPIO(66)
#PE5  TIM15_CH1 TIM15 PWM(11) GPIO(4) NODMA

# LED strip
PE6 TIM15_CH2 TIM15 PWM(12) GPIO(5) NODMA

# no built-in compass, but probe the i2c bus for all possible
# external compass types
define ALLOW_ARM_NO_COMPASS
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define HAL_I2C_INTERNAL_MASK 0
define HAL_COMPASS_AUTO_ROT_DEFAULT 2

# buzzer
PC13 BUZZER OUTPUT LOW PULLDOWN GPIO(7)
define HAL_BUZZER_PIN 7


# save some flash
define HAL_PARACHUTE_ENABLED 0
define HAL_RUNCAM_ENABLED 0
define OSD_ENABLED 0

define DEFAULT_NTF_LED_TYPES 257

include ../include/minimize_features.inc